{% extends "base.html" %}
{% load static %}

{% block title %}Carte DVF interactive{% endblock %}
{% block header_title %}Carte Leaflet des transactions{% endblock %}
{% block header_subtitle %}Explorez les intensites de ventes par departement et commune{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="{% static 'dvf_app/css/map.css' %}">
    <link rel="stylesheet" href="{% static 'dvf_app/css/charts.css' %}">
{% endblock %}

{% block content %}
    <section class="dashboard-kpis" id="dvf-kpi-bar">
        <article class="kpi-card" data-kpi="total-sales">
            <span class="kpi-icon" aria-hidden="true">ðŸ§®</span>
            <div class="kpi-copy">
                <p class="kpi-label">Total ventes</p>
                <p class="kpi-value" id="kpi-total-sales">...</p>
            </div>
        </article>
        <article class="kpi-card" data-kpi="total-value">
            <span class="kpi-icon" aria-hidden="true">ðŸ’¶</span>
            <div class="kpi-copy">
                <p class="kpi-label">Total valeur fonciere</p>
                <p class="kpi-value" id="kpi-total-value">...</p>
            </div>
        </article>
        <article class="kpi-card" data-kpi="median-price">
            <span class="kpi-icon" aria-hidden="true">ðŸ“ˆ</span>
            <div class="kpi-copy">
                <p class="kpi-label">Prix/mÂ² bati (mediane)</p>
                <p class="kpi-value" id="kpi-median-price">...</p>
            </div>
        </article>
        <article class="kpi-card" data-kpi="period">
            <span class="kpi-icon" aria-hidden="true">ðŸ“…</span>
            <div class="kpi-copy">
                <p class="kpi-label">Periode active</p>
                <p class="kpi-value" id="kpi-period">...</p>
            </div>
        </article>
    </section>
    <section
        class="glass-panel"
        id="dvf-map-page"
        data-heatmap-url="{% url 'dvf_app:heatmap-data' %}"
        data-commune-options-url="{% url 'dvf_app:commune-options' %}"
    >
    <section
        class="glass-panel"
        id="dvf-map-page"
        data-heatmap-url="{% url 'dvf_app:heatmap-data' %}"
        data-commune-options-url="{% url 'dvf_app:commune-options' %}"
    >
        <form id="filters" class="filter-grid" autocomplete="off">
            <div>
                <label for="department-select">Departement</label>
                <select id="department-select" name="department">
                    <option value="">Tous les departements</option>
                    {% for department in departments %}
                        <option value="{{ department.code }}">{{ department.code }} - {{ department.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="commune-select">Commune</label>
                <select id="commune-select" name="commune" disabled>
                    <option value="">Toutes les communes</option>
                </select>
            </div>
            <div>
                <label>&nbsp;</label>
                <button type="submit">Actualiser la carte</button>
            </div>
        </form>

        <div class="map-layout">
            <aside class="map-summary">
                <div class="summary-kpis">
                    <article class="stat-card kpi-mini" data-kpi="summary-total-sales">
                        <span class="kpi-icon" aria-hidden="true">ðŸ§®</span>
                        <div class="kpi-copy">
                            <p class="kpi-label">Total ventes</p>
                            <p class="kpi-value" id="summary-total-sales">...</p>
                        </div>
                    </article>
                    <article class="stat-card kpi-mini" data-kpi="summary-total-value">
                        <span class="kpi-icon" aria-hidden="true">ðŸ’¶</span>
                        <div class="kpi-copy">
                            <p class="kpi-label">Total valeur fonciere</p>
                            <p class="kpi-value" id="summary-total-value">...</p>
                        </div>
                    </article>
                    <article class="stat-card kpi-mini" data-kpi="summary-median-price">
                        <span class="kpi-icon" aria-hidden="true">ðŸ“ˆ</span>
                        <div class="kpi-copy">
                            <p class="kpi-label">Prix/mÂ² bati</p>
                            <p class="kpi-value" id="summary-median-price">...</p>
                        </div>
                    </article>
                </div>
                <div class="stat-card legend">
                    <span><span class="dot dot-strong"></span> Forte intensite</span>
                    <span><span class="dot dot-medium"></span> Intensite moyenne</span>
                    <span><span class="dot dot-light"></span> Faible intensite</span>
                </div>
            </aside>
            <div id="dvf-map"></div>
        </div>
        <section
            class="charts-section"
            id="dvf-charts"
            data-charts-url="{% url 'dvf_app:charts-data' %}"
        >
            <div class="charts-section__header">
                <div>
                    <h2>Graphiques couples</h2>
                    <p id="charts-context-label">France entiere</p>
                </div>
                <div class="charts-section__badges" id="charts-badges"></div>
            </div>
            <div class="charts-grid">
                <article class="chart-card" data-chart="top-communes">
                    <div class="chart-card__header">
                        <div>
                            <h3>Top communes</h3>
                            <p class="chart-card__subtitle" id="top-communes-scope">France entiere</p>
                        </div>
                        <div class="chart-card__actions" role="group" aria-label="Choix de metrique">
                            <button type="button" class="chart-toggle is-active" data-metric="sales_count">Nb ventes</button>
                            <button type="button" class="chart-toggle" data-metric="total_value">Volume ventes</button>
                        </div>
                    </div>
                    <div class="chart-card__body">
                        <canvas aria-label="Classement des communes" role="img"></canvas>
                        <div class="chart-placeholder">Chargement...</div>
                    </div>
                </article>
                <article class="chart-card" data-chart="time-series">
                    <div class="chart-card__header">
                        <h3>Serie temporelle</h3>
                        <p class="chart-card__subtitle">Volume mensuel</p>
                    </div>
                    <div class="chart-card__body">
                        <canvas aria-label="Serie temporelle des ventes" role="img"></canvas>
                        <div class="chart-placeholder">Chargement...</div>
                    </div>
                </article>
                <article class="chart-card" data-chart="price-boxplot">
                    <div class="chart-card__header">
                        <h3>Prix au m2</h3>
                        <p class="chart-card__subtitle">Distribution par type</p>
                    </div>
                    <div class="chart-card__body">
                        <canvas aria-label="Distribution des prix" role="img"></canvas>
                        <div class="chart-placeholder">Chargement...</div>
                    </div>
                </article>
                <article class="chart-card" data-chart="mutation-stack">
                    <div class="chart-card__header">
                        <h3>Natures de mutation</h3>
                        <p class="chart-card__subtitle">Repartition par type de bien</p>
                    </div>
                    <div class="chart-card__body">
                        <canvas aria-label="Repartition des natures de mutation" role="img"></canvas>
                        <div class="chart-placeholder">Chargement...</div>
                    </div>
                </article>
            </div>
        </section>
    </section>
{% endblock %}

{% block extra_scripts %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.5/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@sgratzl/chartjs-chart-boxplot@4.4.0"></script>
    <script src="{% static 'dvf_app/js/map.js' %}"></script>
    <script src="{% static 'dvf_app/js/charts.js' %}"></script>
{% endblock %}
